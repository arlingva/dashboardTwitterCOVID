---
title: "Sentimientos en twitter y su relación con el número de casos confirmados de COVID-19"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: yeti
---

```{r, message = FALSE, echo= FALSE}
library(twitteR)
library(tidyverse)
library(tidytext)
library(lubridate)
library(magrittr)
library(xts)
library(dygraphs)
library(reshape2)
library(TTR)
library(imputeTS)
library(readxl)
library(janitor)
library(SnowballC)
library(tm)
library(syuzhet)
library(kableExtra)
library(plotly)
library(flexdashboard)
library(wordcloud)
library(RColorBrewer)
```

```{r, message = FALSE, echo= FALSE}
source("funciones/customWC.R")

df.palabras <- read.csv("tidyTablas/df.palabras.csv")

df.tweet.date <- read.csv("tidyTablas/df.tweet.date.csv")
df.tweet.date$Fecha %<>% ymd()

df <- read.csv("tidyTablas/df.csv")
```

### Introducción {data-commentary-width=500}

```{r pressure, echo=FALSE, fig.cap="Célida López Cárdenas, Andrés Manuel López Obrador y Claudia Pavlovich", out.width = "40%" }
knitr::include_graphics("imagenes/3niveles.png")
```

***

#### ¿La polaridad de sentimientos en twitter se ha visto afectada por el número de casos confirmados de COVID-19?

El objetivo de este _storyboard_ es responder esa pregunta para tres niveles de gobierno:

- Presidente de la República: Andres Manuel Lopez Obrador [@lopezobrador_](https://twitter.com/lopezobrador_)

- Gobernadora del Estado de Sonora: Claudia Pavlovich Arellano [@ClaudiaPavlovic](https://twitter.com/ClaudiaPavlovic)

- Alcaldesa de Hermosillo: Célida López Cárdenas [@CelidaLopezc](https://twitter.com/CelidaLopezc)

Para el análisis de sentimientos se utilizó una traducción automática del léxico Afinn; éste, es un conjunto de palabras con puntuación entre -4 y -1 si son percibidas de forma negativa y entre 1 y 4 si se perciben positivamente; si bien tiene sus limitaciones, cumple con el propósito de este proyecto.

#### Un análisis exploratorio totalmente apartidista

### Este es el top 10 de palabras positivas, los usarios están ordenados según su screen name en twitter

```{r, message = FALSE, echo = FALSE}
sentimiento <- "Positiva"

df.palabras %>%
  filter(Tipo ==  sentimiento) %>%
  group_by(screenName) %>%
  count(Palabra, sort = T) %>%
  arrange(-n, screenName) %>%
  top_n(n = 10, wt = n) %>%
  ggplot() +
  aes(Palabra, n, fill = screenName) +
  geom_col()+ 
  facet_wrap("screenName", scales = "free") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_flip() +
  #labs(title = sentimiento) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
      strip.background = element_rect(fill = "gray", colour = NA),
      legend.position = "none"
      )
```

### La diferencia de vocabulario entre usuarios es evidente; se muestra el top 10 de palabras con carga negativa

```{r, message = FALSE, echo = FALSE}
sentimiento <- "Negativa"

df.palabras %>%
  filter(Tipo ==  sentimiento) %>%
  group_by(screenName) %>%
  count(Palabra, sort = T) %>%
  arrange(-n, screenName) %>%
  top_n(n = 10, wt = n) %>%
  ggplot() +
  aes(Palabra, n, fill = screenName) +
  geom_col()+ 
  facet_wrap("screenName", scales = "free") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_flip() +
  #labs(title = sentimiento) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
      strip.background = element_rect(fill = "gray", colour = NA),
      legend.position = "none"
      )
```

### Análisis de sentimientos por fecha. En la gráfica se muestran datos interpolados linealmente y con suavizamiento por medias móviles.

```{r, message = FALSE, echo = FALSE}
nSMA <- 10

df.interpolado <- df.tweet.date %>%
  transmute(AMLO = na_interpolation(lopezobrador_),
         CPA = na_interpolation(ClaudiaPavlovic),
         CLC = na_interpolation(CelidaLopezc)) %>%
  cbind(Fecha = df.tweet.date$Fecha)

df.SMA <- df.interpolado %>%
  transmute(AMLO.SMA = SMA(AMLO, n = nSMA),
            CPA.SMA = SMA(CPA, n = nSMA),
            CLC.SMA = SMA(CLC, n = nSMA)) %>%
  cbind(Fecha = df.tweet.date$Fecha) 

xts.SMA <- xts(df.SMA %>% 
                 select(-Fecha),
               order.by = df.SMA$Fecha)
xts.SMA <-  xts.SMA[nSMA:length(xts.SMA[,1]),]

dygraph(xts.SMA) %>%
  dyOptions(fillGraph = TRUE, pointShape = "ex") %>%
  dyRangeSelector()
```

```{r}
df.palabras %>% 
  group_by(screenName) %>% 
  distinct(Palabra) %>% 
  count() %>% 
  kbl() %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) 
```

```{r}
df.palabras %>% 
  group_by(screenName, Fecha) %>% 
  summarise(media = mean(Puntuacion, na.rm = TRUE)) %>%
  group_by(screenName) %>%
  summarise(media = mean(media, na.rm = TRUE))
```

### Casos confirmados por día en México _vs_ puntos promedio del Presidente de la República {data-commentary-width=500}

```{r, message = FALSE, echo = FALSE}
fig <- plot_ly(data = df, x = ~confirmados.Nacional, y = ~lopezobrador_,
               marker = list(size = 10,
                             color = 'lightskyblue',
                             line = list(color = 'blue',
                                         width = 1)))
fig
```

***

```{r, echo = FALSE}
cor.test(df$confirmados.Nacional, df$lopezobrador_)
```

### Nube de palabras de Andrés Manuel López Obrador

```{r, message = FALSE, echo = FALSE}
customWC("lopezobrador_", df.palabras)
```

### Casos confirmados por día en Sonora _vs_ puntos promedio de la Gobernadora del Estado {data-commentary-width=500}

```{r, message = FALSE, echo = FALSE}
fig <- plot_ly(data = df, x = ~confirmados.Sonora, y = ~ClaudiaPavlovic,
               marker = list(size = 10,
                             color = 'darkseagreen',
                             line = list(color = 'green',
                                         width = 1)))
fig
```

***

```{r, echo = FALSE}
cor.test(df$confirmados.Sonora, df$ClaudiaPavlovic)
```

### Nube de palabras de Claudia Pavlovich Arellano

```{r, message = FALSE, echo = FALSE}
customWC("ClaudiaPavlovic", df.palabras)
```

### Casos confirmados por día en Hermosillo _vs_ puntos promedio de la alcaldesa de Hermosillo {data-commentary-width=500}

```{r, message = FALSE, echo = FALSE}
fig <- plot_ly(data = df, x = ~confirmados.Hermosillo, y = ~CelidaLopezc,
               marker = list(size = 10,
                             color = 'indianred',
                             line = list(color = 'darkred',
                                         width = 1)))
fig

```

***

```{r, echo = FALSE}
cor.test(df$confirmados.Hermosillo, df$CelidaLopezc)
```

### Nube de palabras de Célida López Cárdenas

```{r, message = FALSE, echo = FALSE}
customWC("CelidaLopezc", df.palabras)
```

### Algunas referencias...

Datos de COVID19 descargados en:

https://www.gob.mx/salud/documentos/datos-abiertos-152127


Para imputar datos:

https://towardsdatascience.com/how-to-handle-missing-data-8646b18db0d4


Ejemplos de análisis de sentimientos en twitter:

https://rpubs.com/Joaquin_AR/334526

https://rpubs.com/jboscomendoza/analisis_sentimientos_lexico_afinn

